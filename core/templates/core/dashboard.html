{% extends 'base.html' %} {# يرث من القالب الأساسي لضمان وجود Tailwind CSS #}
{% load static %} {# لتحميل الملفات الثابتة إذا لزم الأمر #}

{% block title %}لوحة التحكم - منصة ضاد{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 md:py-12 text-right"> {# إضافة مساحة داخلية وتأكيد محاذاة النص لليمين #}

    {# رسالة الترحيب الرئيسية والرسائل العامة #}
    <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg mb-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-blue-800 mb-2">أهلاً بك، <span class="text-green-600">{{ user.full_name|default:user.username }}</span>!</h1>
        <p class="text-lg text-gray-700 mb-6">{{ message }}</p>

        {# رسائل Django (نجاح، خطأ، تحذير) - تحسين تصميمها #}
        {% if messages %}
            <ul class="mb-6 space-y-3">
                {% for message in messages %}
                    <li class="p-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-800 border-r-4 border-green-500{% elif message.tags == 'error' %}bg-red-100 text-red-800 border-r-4 border-red-500{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-800 border-r-4 border-yellow-500{% else %}bg-blue-100 text-blue-800 border-r-4 border-blue-500{% endif %}" role="alert">
                        <i class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %} ml-2 text-xl align-middle"></i>
                        <span class="font-medium text-base">{{ message }}</span>
                    </li>
                {% endfor %}
            </ul>
        {% endif %}

        {# رسالة خاصة لحالة حساب الطالب بعد اختبار تحديد المستوى إذا لم يتم تفعيله #}
        {% if show_activation_message %}
            <div class="bg-orange-100 text-orange-800 border-r-4 border-orange-500 px-6 py-4 rounded-lg relative mb-6" role="alert">
                <i class="fas fa-hourglass-half ml-2 text-2xl align-middle"></i>
                <strong class="font-bold">حسابك قيد المراجعة!</strong>
                <span class="block sm:inline">تم تحديد مستواك في اللغة العربية بـ "<strong>{{ user.get_determined_arabic_level_display }}</strong>". سيتواصل فريق الإدارة معك قريباً لتفعيل حسابك وتجهيز صفك. نعتذر عن الإزعاج ونشكر تفهمك.</span>
            </div>
        {% endif %}
    </div>

    {# قسم البطاقات الرئيسية (معلومات الحساب، الجلسات القادمة، شريط التقدم) #}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        {# بطاقة معلومات الطالب #}
        <div class="bg-blue-50 p-6 rounded-lg shadow-md border-r-4 border-blue-500 flex flex-col justify-between">
            <div>
                <h3 class="text-xl font-semibold text-blue-800 mb-4 flex items-center">
                    <i class="fas fa-user-circle ml-2 text-2xl"></i> معلومات الحساب
                </h3>
                <p class="text-gray-700 mb-2"><strong>اسم المستخدم:</strong> {{ user.username }}</p>
                <p class="text-gray-700 mb-2"><strong>البريد الإلكتروني:</strong> {{ user.email }}</p>
                <p class="text-gray-700 mb-2"><strong>الدور:</strong> {{ user.get_role_display }}</p>
                <p class="text-gray-700 mb-2"><strong>رقم الواتساب:</strong> {{ user.phone_number|default:'غير متوفر' }}</p>
                <p class="text-gray-700 mb-2"><strong>البلد:</strong> {{ user.country|default:'غير متوفر' }}</p>
                <p class="text-gray-700 mb-2"><strong>المستوى المحدد:</strong> {{ user.get_determined_arabic_level_display|default:'لم يتم التحديد بعد' }}</p>
                <p class="text-gray-700"><strong>حالة الحساب:</strong>
                    {% if user.is_active %}
                        <span class="text-green-600 font-bold">مفعل <i class="fas fa-check-circle mr-1"></i></span>
                    {% else %}
                        <span class="text-red-600 font-bold">مجمد <i class="fas fa-exclamation-circle mr-1"></i></span>
                    {% endif %}
                </p>
            </div>
            <div class="mt-4 text-left"> {# زر تعديل الملف الشخصي #}
                <a href="#" class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    <i class="fas fa-edit ml-2"></i> تعديل الملف الشخصي
                </a>
            </div>
        </div>

        {# بطاقة الجلسات القادمة #}
        <div class="bg-green-50 p-6 rounded-lg shadow-md border-r-4 border-green-500">
            <h3 class="text-xl font-semibold text-green-800 mb-4 flex items-center">
                <i class="fas fa-calendar-alt ml-2 text-2xl"></i> الجلسات القادمة
            </h3>
            {% if upcoming_classes %}
                <div class="space-y-4">
                    {% for class_session in upcoming_classes %}
                        <div class="bg-white p-4 rounded-lg shadow-sm border-r-4 border-green-300">
                            <h4 class="text-lg font-semibold text-gray-800 mb-1">{{ class_session.course.name }}</h4>
                            <p class="text-gray-600 text-sm mb-1">المعلم: {{ class_session.teacher.get_full_name|default:class_session.teacher.username }}</p>
                            <p class="text-gray-600 text-sm mb-3">الوقت: {{ class_session.start_time|date:"Y-m-d H:i" }} - {{ class_session.end_time|date:"H:i" }}</p>
                            
                            {# زر الانضمام المباشر - منطق تفعيله بالـ JavaScript #}
                            <div class="mt-3 text-left">
                                <a href="#" 
                                   class="join-live-btn inline-flex items-center bg-blue-600 text-white font-bold py-2 px-4 rounded-md opacity-50 cursor-not-allowed transition duration-200"
                                   data-start-time="{{ class_session.start_time|date:'c' }}" {# 'c' لتنسيق ISO 8601 #}
                                   data-end-time="{{ class_session.end_time|date:'c' }}"
                                   data-join-link="{% if class_session.meeting_link %}{{ class_session.meeting_link }}{% else %}#{% endif %}" {# استخدام meeting_link الفعلي #}
                                   target="_blank" rel="noopener noreferrer">
                                   <i class="fas fa-video ml-2"></i> انضمام مباشر
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-600 text-center py-4">لا توجد جلسات مجدولة حالياً.</p>
            {% endif %}
        </div>

        {# بطاقة شريط التقدم #}
        <div class="bg-yellow-50 p-6 rounded-lg shadow-md border-r-4 border-yellow-500 flex flex-col justify-between">
            <div>
                <h3 class="text-xl font-semibold text-yellow-800 mb-4 flex items-center">
                    <i class="fas fa-chart-line ml-2 text-2xl"></i> شريط التقدم العام
                </h3>
                <div class="w-full bg-gray-200 rounded-full h-4 mb-3">
                    <div class="bg-yellow-500 h-4 rounded-full" style="width: {{ overall_progress_percentage|default:0 }}%;"></div> {# استخدام 0 كقيمة افتراضية #}
                </div>
                <p class="text-gray-600 text-sm mb-4">لقد أكملت <strong class="text-yellow-700">{{ overall_progress_percentage|default:0 }}%</strong> من رحلتك التعليمية حتى الآن.</p>
            </div>
            <div class="mt-auto text-left"> {# زر عرض التفاصيل #}
                <a href="#" class="inline-flex items-center bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                    <i class="fas fa-info-circle ml-2"></i> عرض التفاصيل
                </a>
            </div>
        </div>
    </div>

    {# شريط البرامج والمواد #}
    <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg border-r-4 border-purple-500">
        <h2 class="text-2xl md:text-3xl font-bold text-purple-800 mb-6 text-center flex items-center justify-center">
            <i class="fas fa-book-open ml-3 text-3xl"></i> برامجك وموادك الدراسية
        </h2>
        {% if user_programs_and_courses %}
            <div class="space-y-8">
                {% for program_data in user_programs_and_courses %}
                    <div class="bg-purple-50 p-6 rounded-lg shadow-md border-r-4 border-purple-300">
                        <h3 class="text-xl font-semibold text-purple-800 mb-3">{{ program_data.program.name }}</h3>
                        <p class="text-gray-700 mb-4">{{ program_data.program.description }}</p>
                        
                        {% if program_data.courses %}
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"> {# إضافة عمود ثالث للشاشات الكبيرة #}
                                {% for course in program_data.courses %}
                                    <a href="{% url 'course_detail' course_id=course.id %}" class="block bg-white p-4 rounded-lg shadow hover:shadow-lg transition duration-200 ease-in-out">
                                        <h4 class="text-lg font-semibold text-blue-700 mb-2 flex items-center">
                                            <i class="fas fa-graduation-cap ml-2 text-xl text-blue-500"></i> {{ course.name }}
                                        </h4>
                                        <p class="text-gray-600 text-sm mb-3">{{ course.description|truncatechars:100 }}</p>
                                        <div class="text-left">
                                            <span class="text-sm text-gray-500 flex items-center">
                                                <i class="fas fa-user-tie ml-2"></i> المعلم: {% if course.teacher %}{{ course.teacher.get_full_name|default:course.teacher.username }}{% else %}لا يوجد بعد{% endif %}
                                            </span>
                                        </div>
                                    </a>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-gray-600 text-center py-4">لا توجد مواد مسجل بها في هذا البرنامج بعد.</p>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // وظيفة لمقارنة الوقت وتفعيل زر الانضمام
        function updateJoinLiveButtons() {
            const now = new Date(); // الوقت الحالي
            const buttons = document.querySelectorAll('.join-live-btn');

            buttons.forEach(button => {
                const startTimeStr = button.dataset.startTime;
                const endTimeStr = button.dataset.endTime;
                const joinLink = button.dataset.joinLink;

                const startTime = new Date(startTimeStr);
                const endTime = new Date(endTimeStr);

                // نافذة الانضمام: 15 دقيقة قبل البدء و 15 دقيقة بعد الانتهاء (قابلة للتعديل)
                const joinWindowStart = new Date(startTime.getTime() - (15 * 60 * 1000));
                const joinWindowEnd = new Date(endTime.getTime() + (15 * 60 * 1000));

                if (now >= joinWindowStart && now <= joinWindowEnd && joinLink && joinLink !== '#') {
                    // إذا كان ضمن نافذة الانضمام والرابط موجود وصالح
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                    button.classList.add('hover:bg-blue-700');
                    button.href = joinLink; // تفعيل الرابط
                } else {
                    // إذا لم يكن ضمن نافذة الانضمام أو الرابط غير صالح
                    button.classList.add('opacity-50', 'cursor-not-allowed');
                    button.classList.remove('hover:bg-blue-700');
                    button.href = '#'; // تعطيل الرابط
                }
            });
        }

        // تحديث الأزرار فوراً عند تحميل الصفحة
        updateJoinLiveButtons();

        // تحديث الأزرار كل دقيقة (لتعكس تغيير الوقت)
        setInterval(updateJoinLiveButtons, 60 * 1000); // كل 60 ثانية
    });
</script>
{% endblock %}