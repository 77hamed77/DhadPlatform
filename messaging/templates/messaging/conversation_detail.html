{% extends 'base.html' %}
{% load static %}

{% block title %}محادثة مع {{ other_user.full_name|default:other_user.username }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100 py-12 px-4 sm:px-6 lg:px-8 text-right"> {# خلفية خفيفة وهوامش #}
    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl border-t-8 border-blue-600 animate-fade-in-down"> {# بطاقة رئيسية أكبر وأكثر تميزاً #}

        {# عنوان المحادثة #}
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-blue-800 mb-2 leading-tight">
                <i class="fas fa-comments text-blue-600 ml-3"></i> محادثة مع
                <span class="text-purple-700">{{ other_user.full_name|default:other_user.username }}</span>
            </h1>
            <a href="{% url 'messaging:inbox' %}" class="text-blue-500 hover:text-blue-700 text-base flex items-center justify-center transition-colors duration-200">
                <i class="fas fa-arrow-right ml-2 text-sm"></i> العودة إلى قائمة المحادثات
            </a>
        </div>

        {# رسائل Django (نجاح، خطأ، تحذير) - تصميم موحد #}
        {% if messages %}
            <ul class="mb-8 space-y-3">
                {% for message in messages %}
                    <li class="p-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-800 border-r-4 border-green-500{% elif message.tags == 'error' %}bg-red-100 text-red-800 border-r-4 border-red-500{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-800 border-r-4 border-yellow-500{% else %}bg-blue-100 text-blue-800 border-r-4 border-blue-500{% endif %} flex items-center" role="alert">
                        <i class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %} ml-3 text-xl"></i>
                        <span class="font-medium text-base">{{ message }}</span>
                    </li>
                {% endfor %}
            </ul>
        {% endif %}

        {# صندوق الرسائل #}
        <div id="messages-container" class="border border-gray-300 p-4 h-[60vh] overflow-y-auto bg-gray-50 rounded-lg shadow-inner mb-6 flex flex-col-reverse relative"> {# ارتفاع أكثر استجابة وظل داخلي #}
            {# الرسائل ستُعرض هنا بترتيب صحيح مع flex-col-reverse لتظهر الأحدث في الأسفل #}
            {% for message in conversation_messages %} {# <<<<<<<<<<<<<<<< التعديل هنا: تمت إزالة |reversed #}
                <div id="message-{{ message.id }}" class="mb-3 p-3 rounded-xl max-w-[80%] break-words animate-fade-in-up
                    {% if message.sender == request.user %}
                        bg-blue-600 text-white self-end text-right ml-auto shadow-md
                    {% else %}
                        bg-gray-200 text-gray-800 self-start text-right mr-auto shadow-md
                    {% endif %}">
                    <p class="font-bold text-sm mb-1 opacity-90">
                        {% if message.sender == request.user %}أنت{% else %}{{ message.sender.full_name|default:message.sender.username }}{% endif %}
                    </p>
                    <p class="text-base">{{ message.content }}</p>
                    <span class="text-xs mt-1 block opacity-70
                        {% if message.sender == request.user %}text-left{% else %}text-right{% endif %}">
                        {{ message.timestamp|date:"H:i Y-m-d" }}
                    </span>
                </div>
            {% empty %}
                <p class="text-center text-gray-500 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full">لا توجد رسائل بعد. ابدأ المحادثة!</p>
            {% endfor %}
        </div>

        {# نموذج إرسال الرسالة #}
        <form method="post" action="{% url 'messaging:conversation_detail' conversation_id=conversation.id %}" class="flex items-center space-x-4 space-x-reverse mt-6" id="message-form"> {# <<<<<<<<<<<<<<<< التعديل هنا: استخدام conversation_detail #}
            {% csrf_token %}
            <div class="flex-grow">
                <input type="text" name="{{ form.content.name }}" id="{{ form.content.id_for_label }}"
                       class="form-input w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-right text-lg"
                       placeholder="اكتب رسالتك هنا..." required autocomplete="off"> {# إضافة autocomplete #}
            </div>
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md transition duration-300 ease-in-out shadow-lg transform hover:scale-105 inline-flex items-center justify-center">
                <i class="fas fa-paper-plane ml-2"></i> إرسال
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('id_content');

        // وظيفة لجلب CSRF token من الكوكيز
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // وظيفة للتمرير إلى الأسفل في صندوق الرسائل
        function scrollToBottom() {
            // التمرير إلى أعلى نقطة في المحتوى (أي أسفل الحاوية نظراً لـ flex-col-reverse)
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // وظيفة لإضافة رسالة جديدة إلى الـ DOM
        function addMessageToDOM(message) {
            const messageDiv = document.createElement('div');
            messageDiv.id = `message-${message.id}`;
            messageDiv.classList.add('mb-3', 'p-3', 'rounded-xl', 'max-w-[80%]', 'break-words', 'shadow-md', 'animate-fade-in-up');

            if (message.is_from_me) {
                messageDiv.classList.add('bg-blue-600', 'text-white', 'self-end', 'text-right', 'ml-auto');
            } else {
                messageDiv.classList.add('bg-gray-200', 'text-gray-800', 'self-start', 'text-right', 'mr-auto');
            }

            // تنسيق التاريخ والوقت
            let formattedTimestamp = '';
            try {
                // تاريخ ووقت ISO 8601 يمكن تحليلهما بسهولة
                const date = new Date(message.timestamp);
                if (!isNaN(date.getTime())) {
                    const year = date.getFullYear();
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    const hours = date.getHours().toString().padStart(2, '0');
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    formattedTimestamp = `${hours}:${minutes} ${year}-${month}-${day}`;
                } else {
                    // fallback if date parsing fails
                    formattedTimestamp = message.timestamp ? message.timestamp.split('T')[1].substring(0, 5) + ' ' + message.timestamp.split('T')[0] : '';
                }
            } catch (e) {
                console.error("Error parsing timestamp:", e);
                formattedTimestamp = message.timestamp ? message.timestamp.split('T')[1].substring(0, 5) + ' ' + message.timestamp.split('T')[0] : '';
            }

            messageDiv.innerHTML = `
                <p class="font-bold text-sm mb-1 opacity-90">${message.is_from_me ? 'أنت' : message.sender_full_name || message.sender_username}</p>
                <p class="text-base">${message.content}</p>
                <span class="text-xs mt-1 block opacity-70
                    {% comment %} ملاحظة: محاذاة النص داخل span الوقت تعتمد على ما إذا كان المرسل هو المستخدم الحالي {% endcomment %}
                    ${message.is_from_me ? 'text-left' : 'text-right'}">
                    ${formattedTimestamp}
                </span>
            `;
            // إضافة الرسالة في الأعلى لتظهر بترتيب عكسي (بسبب flex-col-reverse)،
            // مما يجعلها تبدو في الأسفل عند التمرير
            messagesContainer.prepend(messageDiv);
        }

        // وظيفة Polling لجلب الرسائل الجديدة
        function fetchNewMessages() {
            // جلب ID آخر رسالة موجودة في الـ DOM (أول عنصر لأننا نستخدم prepend)
            const firstMessageElement = messagesContainer.querySelector('div[id^="message-"]');
            const lastMessageId = firstMessageElement ? parseInt(firstMessageElement.id.replace('message-', '')) : 0;

            const conversationId = "{{ conversation.id }}"; // استخدام معرف المحادثة من سياق Django

            fetch(`/messages/${conversationId}/?last_message_id=${lastMessageId}`, { // <<<<<<<<<<<<<<<< التعديل هنا: استخدام مسار conversation_detail
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.messages && data.messages.length > 0) {
                    // الرسائل تأتي من الـ view مرتبة من الأقدم للأحدث،
                    // والـ prepend يضيفها في بداية الحاوية، مما يجعلها تظهر في الأسفل بسبب flex-col-reverse
                    // لذا لا نحتاج لـ .reverse() هنا إذا كان الـ view يرسل أقدم رسالة أولاً
                    data.messages.forEach(message => { // لا يوجد .reverse() هنا
                        addMessageToDOM(message);
                    });
                    scrollToBottom(); // التمرير إلى الأسفل بعد إضافة الرسائل الجديدة
                }
            })
            .catch(error => console.error('Error fetching new messages:', error));
        }

        // تشغيل وظيفة Polling كل 3 ثواني (يمكن تعديل المدة)
        setInterval(fetchNewMessages, 3000); // 3000ms = 3 seconds

        // التمرير للأسفل عند تحميل الصفحة لأول مرة
        // يجب أن يتم التمرير بعد ضمان تحميل جميع الرسائل الأولية
        // قد تحتاج إلى تأخير بسيط إذا كانت الرسوم المتحركة تؤثر على ارتفاع المحتوى
        setTimeout(scrollToBottom, 100); // تأخير بسيط للسماح للرسوم المتحركة بالانتهاء

        // معالجة إرسال النموذج باستخدام AJAX
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault(); // منع الإرسال الافتراضي للصفحة

            const formData = new FormData(messageForm);
            const messageContent = messageInput.value.trim(); // إزالة المسافات البيضاء

            if (!messageContent) { // منع إرسال رسائل فارغة
                console.warn('Cannot send empty message.');
                return;
            }

            fetch(messageForm.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest', // للإشارة إلى طلب AJAX
                },
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.json(); // نتوقع استجابة JSON
                } else {
                    // في حالة وجود خطأ، حاول قراءة النص للاطلاع على التفاصيل
                    return response.text().then(text => { throw new Error(text) });
                }
            })
            .then(data => {
                if (data.status === 'success' && data.message) {
                    // الرسالة المرسلة هي رسالتنا، لذا أضفها مباشرة إلى DOM
                    addMessageToDOM(data.message);
                    messageInput.value = ''; // مسح حقل الإدخال
                    scrollToBottom(); // التمرير لأسفل
                } else {
                    console.error('Error sending message:', data.errors || data.message || 'Unknown error');
                    // يمكنك عرض رسالة خطأ للمستخدم هنا (مثال: استخدام رسائل Django)
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                // يمكنك عرض رسالة خطأ عامة للمستخدم هنا
            });
        });
    });
</script>
{% endblock %}

{% block extra_head %}
<style>
    /* الرسوم المتحركة */
    @keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-down {
        animation: fadeInDown 0.7s ease-out forwards;
    }
    .animate-fade-in-up {
        animation: fadeInUp 0.5s ease-out forwards;
    }

    /* تعريف كلاس form-input ليستخدم Tailwind CSS */
    .form-input {
        @apply block px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-lg;
        text-align: right; /* لضمان محاذاة النص داخل الحقول لليمين */
        direction: rtl; /* لضمان اتجاه النص من اليمين لليسار للحقول المدخلة يدويًا */
    }
    /* لضمان أن الرسائل من المستخدم الحالي تظهر على اليسار داخل حاوية RTL */
    /* ولكن محاذاة النص داخل الفقرة تظل لليمين */
    .self-end.text-left p { /* هذا يستهدف الفقرات داخل الرسالة الخاصة بك */
        text-align: right;
    }
    .self-end .text-left { /* هذا يستهدف الـ span للوقت داخل الرسالة الخاصة بك */
        text-align: left; /* الوقت يظل على اليسار داخل الفقاعة */
    }

    /* لضمان أن الرسائل من المستخدم الآخر تظهر على اليمين داخل حاوية RTL */
    /* ومحاذاة النص داخل الفقرة تظل لليمين */
    .self-start.text-right p { /* هذا يستهدف الفقرات داخل رسالة الطرف الآخر */
        text-align: right;
    }
    .self-start .text-right { /* هذا يستهدف الـ span للوقت داخل رسالة الطرف الآخر */
        text-align: right; /* الوقت يظل على اليمين داخل الفقاعة */
    }
</style>
{% endblock %}