{% extends 'base.html' %}
{% load static %}
{% load humanize %} {# لإظهار التاريخ بشكل أجمل (مثل "منذ 3 أيام") #}

{% block extra_head %}
    {# إضافة Font Awesome إذا لم تكن موجودة بالفعل في base.html #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    {# إضافة أي CSS خاص بهذه الصفحة هنا #}
    <style>
        .tab-button.active {
            border-bottom: 3px solid #3B82F6; /* أزرق Tailwind css-blue-500 */
            color: #3B82F6;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active-tab-content {
            display: block;
        }
        .lesson-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: #BFDBFE; /* light blue */
        }
        .assignment-status {
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            display: inline-block;
        }
        .status-pending { background-color: #FEF3C7; color: #92400E; } /* Yellow */
        .status-graded { background-color: #D1FAE5; color: #065F46; } /* Green */
        .status-resubmit { background-color: #FEE2E2; color: #991B1B; } /* Red */

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .tab-buttons {
                flex-wrap: wrap;
            }
            .tab-button {
                flex-basis: 50%; /* Two buttons per row on small screens */
                text-align: center;
                margin-bottom: 0.5rem;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <nav class="text-gray-700 text-sm mb-6" aria-label="breadcrumb">
        <ol class="list-none p-0 inline-flex">
            <li class="flex items-center">
                <a href="{% url 'core:index' %}" class="text-blue-600 hover:text-blue-800">الرئيسية</a>
                <span class="mx-2">/</span>
            </li>
            <li class="flex items-center">
                <a href="{% url 'core:dashboard' %}" class="text-blue-600 hover:text-blue-800">لوحة التحكم</a>
                <span class="mx-2">/</span>
            </li>
            <li class="flex items-center">
                <span class="text-gray-500">{{ course.name }}</span>
            </li>
        </ol>
    </nav>

    <div class="bg-white shadow-xl rounded-lg p-6 mb-8">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-4">{{ course.name }}</h1>
        <p class="text-gray-700 text-lg mb-6">{{ course.description }}</p>

        <div class="flex items-center text-gray-600 mb-4">
            <i class="fas fa-chalkboard-teacher ml-2"></i>
            {% if course.classes.first.teacher %}
                <span>المعلم: {{ course.classes.first.teacher.get_full_name }}</span>
            {% else %}
                <span>المعلم: غير محدد</span>
            {% endif %}
        </div>

        {% if not is_subscribed %}
            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6" role="alert">
                <p class="font-bold">غير مشترك في الدورة</p>
                <p>للتحكم في الوصول إلى محتوى هذه الدورة، يجب أن تكون مشتركًا في إحدى حلقاتها الدراسية. يمكنك التواصل مع الإدارة للتسجيل.</p>
            </div>
        {% else %}
            {% if student_class %}
                <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-6" role="alert">
                    <p class="font-bold">مشترك في الدورة</p>
                    <p>أنت مسجل حاليًا في حلقة: <strong>{{ student_class.class_code }}</strong> مع المعلم <strong>{{ student_class.teacher.get_full_name }}</strong>. تاريخ بدء الجلسة: <strong>{{ student_class.start_time|date:"Y-m-d H:i" }}</strong>.</p>
                </div>
            {% else %}
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
                    <p class="font-bold">خطأ في الاشتراك</p>
                    <p>أنت مشترك في الدورة ولكن لم يتم تحديد حلقة دراسية لك بشكل صحيح. يرجى التواصل مع الإدارة.</p>
                </div>
            {% endif %}
        {% endif %}
    </div>

    {# Tab Navigation #}
    <div class="bg-white shadow-xl rounded-lg p-6 mb-8">
        <div class="border-b border-gray-200">
            <nav class="flex flex-col sm:flex-row -mb-px text-lg font-medium text-center text-gray-500 tab-buttons" role="tablist">
                <button class="flex-grow py-4 px-1 border-b-2 border-transparent hover:border-blue-300 transition duration-150 ease-in-out tab-button active" data-tab="lessons-content" role="tab" aria-controls="lessons-content" aria-selected="true">
                    الدروس
                </button>
                <button class="flex-grow py-4 px-1 border-b-2 border-transparent hover:border-blue-300 transition duration-150 ease-in-out tab-button" data-tab="files-content" role="tab" aria-controls="files-content" aria-selected="false">
                    الملفات التعليمية
                </button>
                <button class="flex-grow py-4 px-1 border-b-2 border-transparent hover:border-blue-300 transition duration-150 ease-in-out tab-button" data-tab="assignments-content" role="tab" aria-controls="assignments-content" aria-selected="false">
                    الواجبات
                </button>
                <button class="flex-grow py-4 px-1 border-b-2 border-transparent hover:border-blue-300 transition duration-150 ease-in-out tab-button" data-tab="classmates-content" role="tab" aria-controls="classmates-content" aria-selected="false">
                    زملائي في الحلقة
                </button>
            </nav>
        </div>

        {# Tab Content - Lessons #}
        <div id="lessons-content" role="tabpanel" aria-labelledby="lessons-tab" class="tab-content active-tab-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">دروس الدورة</h3>
            {% if lessons %}
                <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    {% for lesson in lessons %}
                        <div class="lesson-card p-5 rounded-lg shadow-md flex flex-col justify-between transition duration-300 ease-in-out transform hover:scale-103">
                            <div>
                                <h4 class="text-xl font-semibold text-gray-900 mb-2">{{ lesson.title }}</h4>
                                <p class="text-gray-600 text-sm mb-3">{{ lesson.description|truncatechars:100 }}</p>

                                {# DEBUG: عرض قيمة youtube_link مباشرة للتأكد #}
                                {# <p class="text-xs text-purple-600 mb-1">DEBUG YouTube Link: {{ lesson.youtube_link }}</p> #}

                                {% if lesson.youtube_link %} {# تم التعديل هنا: lesson.youtube_link #}
                                    <div class="mb-3">
                                        <a href="{{ lesson.youtube_link }}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 font-medium flex items-center">
                                            <i class="fab fa-youtube ml-2 text-red-600 text-2xl"></i> مشاهدة الفيديو (رابط خارجي)
                                        </a>
                                    </div>
                                {% else %}
                                    <div class="bg-red-100 text-red-700 p-2 rounded-md text-sm flex items-center mt-3">
                                        <i class="fas fa-exclamation-triangle ml-2"></i>
                                        <span>عذراً، لا يوجد رابط فيديو متاح لهذا الدرس حالياً.</span>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="text-right text-gray-500 text-xs mt-4">
                                <span>نشر في: {{ lesson.published_date|naturaltime }}</span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-600 text-lg text-center p-8">لا توجد دروس متاحة حالياً لهذه الدورة.</p>
            {% endif %}
        </div>

        {# Tab Content - Educational Files #}
        <div id="files-content" role="tabpanel" aria-labelledby="files-tab" class="tab-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">الملفات التعليمية</h3>
            {% if educational_files %}
                <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    {% for file in educational_files %}
                        <div class="p-5 rounded-lg shadow-md flex flex-col justify-between transition duration-300 ease-in-out transform hover:scale-103 border border-gray-200 hover:border-blue-200">
                            <div>
                                <h4 class="text-xl font-semibold text-gray-900 mb-2">{{ file.title }}</h4>
                                <p class="text-gray-600 text-sm mb-3">{{ file.description|truncatechars:100 }}</p>
                                {% if file.file %}
                                    <div class="mb-3">
                                        <a href="{{ file.file.url }}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 font-medium flex items-center">
                                            <i class="fas fa-download ml-2 text-blue-500 text-lg"></i> تحميل الملف
                                        </a>
                                    </div>
                                {% else %}
                                    <div class="bg-red-100 text-red-700 p-2 rounded-md text-sm flex items-center mt-3">
                                        <i class="fas fa-exclamation-triangle ml-2"></i>
                                        <span>الملف غير متاح حالياً.</span>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="text-right text-gray-500 text-xs mt-4">
                                <span>رفع في: {{ file.uploaded_at|naturaltime }}</span>
                                {% if file.uploaded_by %}
                                    <span>بواسطة: {{ file.uploaded_by.get_full_name }}</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-600 text-lg text-center p-8">لا توجد ملفات تعليمية متاحة حالياً لهذه الدورة.</p>
            {% endif %}
        </div>

        {# Tab Content - Assignments #}
        <div id="assignments-content" role="tabpanel" aria-labelledby="assignments-tab" class="tab-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">الواجبات</h3>
            {% if is_subscribed %}
                {% if assignments %}
                    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                        {% for data in assignments %}
                            <div class="p-5 rounded-lg shadow-md flex flex-col justify-between transition duration-300 ease-in-out transform hover:scale-103 border border-gray-200 hover:border-blue-200">
                                <div>
                                    <h4 class="text-xl font-semibold text-gray-900 mb-2">{{ data.assignment.title }}</h4>
                                    <p class="text-gray-600 text-sm mb-3">{{ data.assignment.description|truncatechars:100 }}</p>
                                    <p class="text-gray-500 text-xs mb-2">تاريخ التسليم: {{ data.assignment.due_date|date:"Y-m-d H:i" }}</p>
                                    <p class="text-gray-500 text-xs mb-3">الدرجة القصوى: {{ data.assignment.max_score }}</p>

                                    {% if data.assignment.assignment_file %}
                                        <div class="mb-3">
                                            <a href="{{ data.assignment.assignment_file.url }}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 font-medium flex items-center">
                                                <i class="fas fa-file-alt ml-2 text-blue-500 text-lg"></i> ملف الواجب
                                            </a>
                                        </div>
                                    {% endif %}

                                    {% if data.has_submitted %}
                                        <div class="bg-blue-100 text-blue-700 p-2 rounded-md text-sm flex items-center mb-3">
                                            <i class="fas fa-check-circle ml-2"></i>
                                            <span>تم تسليم الواجب.</span>
                                            {% if data.submitted_data.status == 'graded' %}
                                                <span class="mr-2">الدرجة: {{ data.submitted_data.score }}</span>
                                            {% endif %}
                                        </div>
                                        {% if data.submitted_data.status == 'resubmit' %}
                                            <div class="bg-yellow-100 text-yellow-700 p-2 rounded-md text-sm flex items-center mb-3">
                                                <i class="fas fa-redo ml-2"></i>
                                                <span>مطلوب إعادة تسليم.</span>
                                            </div>
                                            {# يمكن إضافة نموذج إعادة تسليم هنا إذا أردت #}
                                        {% endif %}
                                    {% else %}
                                        <form method="post" action="{% url 'academic:submit_assignment' assignment_id=data.assignment.id %}" enctype="multipart/form-data" class="mt-4">
                                            {% csrf_token %}
                                            {{ data.submission_form.as_p }}
                                            <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-200">
                                                <i class="fas fa-upload ml-2"></i> تسليم الواجب
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-600 text-lg text-center p-8">لا توجد واجبات متاحة حالياً لهذه الدورة.</p>
                {% endif %}
            {% else %}
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                    <p class="font-bold">غير مشترك</p>
                    <p>الواجبات متاحة للطلاب المشتركين فقط في هذه الدورة.</p>
                </div>
            {% endif %}
        </div>

        {# Tab Content - Classmates #}
        <div id="classmates-content" role="tabpanel" aria-labelledby="classmates-tab" class="tab-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">زملائي في الحلقة</h3>
            {% if is_subscribed %}
                {% if classmates %}
                    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                        {% for classmate in classmates %}
                            <div class="bg-gray-50 p-4 rounded-lg shadow-sm flex items-center transition duration-300 ease-in-out transform hover:scale-103">
                                {% comment %} علقت الصورة لانه ممكن بنت تحط صورتها الحقيقية و هي كمان فيها خطأ {% endcomment %}
                                {% comment %} <img src="{{ classmate.profile_picture.url|default:'/static/images/default_profile.png' }}" alt="{{ classmate.get_full_name }}" class="w-12 h-12 rounded-full object-cover mr-4"> {% endcomment %}
                                <div>
                                    <p class="font-semibold text-gray-800">{{ classmate.get_full_name }}</p>
                                    <p class="text-gray-600 text-sm">{{ classmate.email }}</p>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-600 text-lg text-center p-8">لا يوجد زملاء في الحلقة حالياً أو أنت الطالب الوحيد.</p>
                {% endif %}
            {% else %}
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                    <p class="font-bold">غير مشترك</p>
                    <p>قائمة الزملاء متاحة للطلاب المشتركين فقط في هذه الدورة.</p>
                </div>
            {% endif %}
        </div>

    </div>{# End of Tab Content Container #}
</div>{# End of main container #}

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove 'active' class from all buttons and hide all contents
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active-tab-content'));

                // Add 'active' class to the clicked button
                this.classList.add('active');

                // Show the corresponding content
                const targetId = this.dataset.tab;
                document.getElementById(targetId).classList.add('active-tab-content');
            });
        });

        // Optional: Activate the first tab by default on page load
        // You can also add logic to remember the last active tab using localStorage
        if (tabButtons.length > 0) {
            tabButtons[0].click(); // Simulate click on the first button to show its content
        }
    });
</script>
{% endblock %}